# Project Masquerade Ark - 项目总结

## 项目概述
**Project Masquerade Ark** 是一个基于LLM驱动的叙事型生存/推理悬疑游戏原型。游戏设定为暴雪山庄模式的丧尸末日背景，采用文字形式实现核心玩法的最小可行产品（MVP）。

## 技术栈
- **引擎**: Godot 4.x (.NET / C#)
- **数据层**: Godot Resource 系统
- **逻辑层**: 纯 C#（与 UI 解耦）
- **叙事层**: LLM 作为 Game Master (预定义模板实现)
- **UI层**: Godot Scene + Control 节点

## 已实现功能

### 🎯 核心数据结构
- **[`Survivor`](src/Core/Survivor.cs)**: 幸存者NPC类，包含生存属性、精神属性、秘密和关系网
- **[`GameState`](src/Core/GameState.cs)**: 游戏世界状态管理，包含天数、物资、防御值、场所系统和幸存者列表
- **[`GameEvent`](src/Core/GameEvent.cs)**: 游戏事件数据结构，支持多种事件类型
- **[`Location`](src/Core/Location.cs)**: 场所系统，支持医疗区、棋牌室、储藏室等功能性场所

### ⚙️ 核心系统
- **[`SimulationEngine`](src/Engine/SimulationEngine.cs)**: 游戏逻辑与数值计算引擎
  - 物资消耗与分配系统
  - 幸存者状态更新（饥饿、压力、感染等）
  - Masquerade机制（偷窃、感染检测等秘密事件）
  - **✨ 随机事件系统**（基于压力、物资状况触发）
  - **🧟 丧尸攻击事件**（破坏防御、攻击幸存者、感染风险）
  - **💥 破坏和拒绝事件**（设施破坏、拒绝合作）
  - 随机秘密分配系统

- **[`NarrativeEngine`](src/Engine/NarrativeEngine.cs)**: 叙事文本生成系统
  - 将数值事件转换为情感化文本
  - 支持多种事件类型的叙事模板
  - 生成玩家选择分支

### 🏢 场所管理系统
- **[`LocationManager`](src/Manager/LocationManager.cs)**: 场所功能管理
  - **医疗区**: 治疗生命值，工程师效果更佳
  - **棋牌室**: 减少压力值
  - **休息区**: 增加幸存者间信任度
  - **储藏室**: 查看物资状况
  - **场所损坏修理机制**: 支持设施被破坏和修复

### 📋 任务管理系统
- **[`TaskManager`](src/Manager/TaskManager.cs)**: 任务分配与执行
  - **任务类型**: 巡逻、修理设施、搜寻物资、站岗、维护装备、心理支持
  - **角色专长**: 不同职业执行任务效果不同
  - **拒绝机制**: 低信任度幸存者可能拒绝任务
  - **进度跟踪**: 支持多天任务的执行管理

### 📊 日志导出系统
- **[`LogExporter`](src/Utilities/LogExporter.cs)**: 游戏数据导出
  - **多格式支持**: TXT、JSON、Markdown格式
  - **完整记录**: 游戏状态、事件日志、幸存者信息、场所状态
  - **自动时间戳**: 导出文件自动命名

### ⏰ 时间机制
- **自动计时器系统**: 可切换手动/自动模式
- **时间推进**: 支持手动点击或自动（10秒一天）
- **自动模式按钮**: 方便的自动/手动切换

### 🎮 游戏管理
- **[`GameManager`](src/Manager/GameManager.cs)**: 协调所有系统的核心管理器
  - 游戏流程控制（初始化 → 模拟 → 叙事 → UI更新）
  - 信号系统解耦各模块通信
  - 投票驱逐功能
  - 调试命令系统
  - 游戏结束条件检测
  - **集成所有新管理器**: LocationManager、TaskManager、LogExporter

### 🖥️ 用户界面
- **[`UIManager`](src/UI/UIManager.cs)**: UI显示与交互管理
  - **改进的布局设计**: 使用面板容器分离各功能区域
  - 实时幸存者状态显示（HP、压力、怀疑度等进度条）
  - 事件日志系统
  - 动态选择按钮生成
  - **场所状态显示**: 展示场所可用性和损坏程度
  - **任务界面**: 显示可用任务和幸存者选择
  - 调试模式（显示NPC秘密）

### 🔧 配置系统
- **[`GameConstants`](src/Utilities/GameConstants.cs)**: 统一的游戏常量管理
  - 物资消耗参数
  - 状态恶化阈值
  - 随机事件概率
  - **新增常量**: 场所效果、丧尸攻击、任务奖励等参数
  - 初始值配置

## 游戏核心玩法

### Masquerade 机制
- **秘密系统**: NPC 拥有隐藏属性（感染、小偷等）
- **信任网络**: NPC之间动态的信任关系
- **线索与推理**: 玩家只能看到结果和线索，需要推理真相
- **投票驱逐**: 团队会议投票驱逐可疑成员

### 生存压力
- **物资管理**: 有限的物资需要合理分配
- **状态恶化**: 饥饿、压力会导致不良后果
- **随机事件**: 基于当前状态触发各种突发事件
- **时间压力**: 在30天内保持团队存活
- **外部威胁**: 丧尸攻击威胁庇护所安全
- **内部冲突**: 破坏行为和拒绝合作

### 策略管理
- **场所利用**: 合理安排幸存者使用不同功能场所
- **任务分配**: 根据角色专长分配巡逻、修理、搜寻等任务
- **设施维护**: 及时修理被破坏的场所设施
- **防御管理**: 维护庇护所防御值抵御外部威胁

## 项目架构

```
src/
├── Core/           # 核心数据结构 (Survivor, GameState, GameEvent, Location)
├── Engine/         # 游戏引擎（模拟、叙事）
├── Manager/        # 游戏管理器 (GameManager, LocationManager, TaskManager)
├── UI/             # 用户界面
└── Utilities/      # 工具类（常量配置、日志导出）

scenes/
└── Main.tscn       # 主场景布局

```

## 最新更新内容

### ✅ 按照最新TODO.md完成的新功能
1. **🏢 场所系统**: 医疗区、棋牌室、储藏室、休息区等功能性场所
2. **📋 任务系统**: 巡逻、修理、搜寻等多样化任务选择
3. **🧟 丧尸威胁**: 攻击庇护所、感染幸存者的外部威胁
4. **💥 破坏事件**: 设施破坏、拒绝合作等内部冲突
5. **📊 日志导出**: 多格式游戏数据导出功能
6. **🎯 角色专长**: 不同职业在任务执行中的效果差异
7. **🛡️ 防御机制**: 庇护所防御值影响丧尸攻击效果

### 🎮 当前游戏状态
- ✅ 核心游戏循环完整实现
- ✅ 所有系统集成测试通过
- ✅ UI交互功能完整
- ✅ 场所和任务系统完全可用
- ✅ 丧尸威胁和内部冲突机制运行正常
- ✅ 日志导出功能测试通过

## 运行方式
1. 确保安装了 Godot 4.x 和 .NET SDK
2. 在项目目录运行 `dotnet build` 编译
3. 用 Godot 打开项目并运行

## 游戏控制
- **推进到下一天**: 手动推进游戏进程，处理任务进度
- **召开会议**: 进行投票驱逐可疑成员  
- **自动模式**: 切换自动/手动时间推进
- **场所管理**: 查看场所状态，安排幸存者使用设施
- **任务分配**: 为幸存者分配各种任务
- **日志导出**: 导出游戏记录和统计信息
- **控制台命令**: 支持调试命令（help, status, secrets等）

## 游戏特色亮点
- **深度策略**: 场所利用、任务分配、资源管理的多层次策略
- **动态威胁**: 内外部威胁相结合，丧尸攻击与内部冲突并存
- **角色专长**: 医生治疗效果好、工程师修理效率高等职业特色
- **信任机制**: 低信任度会导致拒绝合作，增加管理难度
- **完整记录**: 详细的游戏日志系统，支持复盘分析

## 下一步发展方向
- 集成真正的 LLM API（替换当前的模板系统）
- 添加更多事件类型和叙事分支
- 实现存档/读档功能
- 添加音效和视觉效果
- 扩展NPC AI行为系统
- 增加更多场所类型和任务种类
- 完善角色专长和技能树系统